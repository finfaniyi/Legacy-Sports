{% extends "tournament/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Team Registration | Legacy Sports{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'tournament/css/signup.css' %}">
{% endblock %}

{% block content %}
<section class="form-page">

  <div class="form-header">
    <h1>Team Registration</h1>
    <p>All teams must register 6 players. Substitutes are optional.</p>
  </div>

  <div class="form-card">
    <form method="POST" action="{% url 'registration_team' %}?slot={{ slot }}">
      {% csrf_token %}

      {% if error %}
      <div class="error-toast">
        ⚠️ {{ error }}
      </div>
      {% endif %}

      <!-- TEAM INFO -->
      <h3>Team Information</h3>

      <div class="team-grid">
        <input type="text" name="team_name" placeholder="Team Name" value="{{ form_data.team_name|default:'' }}">

        <input type="text" name="captain_name" placeholder="Captain Full Name"
          value="{{ form_data.captain_name|default:'' }}">

        <div class="field-group">
          <input type="email" name="captain_email" placeholder="Captain Email"
            value="{{ form_data.captain_email|default:'' }}"
            class="{% if error_field == 'captain_email' %}input-error{% endif %}">
          {% if error_field == "captain_email" %}
          <p class="field-error">⚠ {{ error_message }}</p>
          {% endif %}
        </div>

        <input type="text" name="captain_phone" placeholder="Captain Phone"
          value="{{ form_data.captain_phone|default:'' }}">
      </div>

      <hr>

      <!-- ROSTER SIZE -->
      <h3>Roster Size</h3>
      <select id="rosterSize" name="roster_size" required>
        <option value="">Select</option>
        <option value="6" {% if form_data.roster_size == "6" %}selected{% endif %}>6 players</option>
        <option value="7" {% if form_data.roster_size == "7" %}selected{% endif %}>7 players</option>
        <option value="8" {% if form_data.roster_size == "8" %}selected{% endif %}>8 players</option>
      </select>

      <hr>

      <!-- ACTIVE PLAYERS -->
      <h3>Active Players (6 required)</h3>

      {% for i in "123456" %}
      <div class="player-card">
        <div class="player-title">Player {{ forloop.counter }}</div>

        {% with key="player_"|add:forloop.counter|stringformat:"s"|add:"_first" %}
        <input name="player_{{ forloop.counter }}_first" placeholder="First Name"
          value="{{ form_data|get_item:key|default:'' }}">
        {% endwith %}

        {% with key="player_"|add:forloop.counter|stringformat:"s"|add:"_last" %}
        <input name="player_{{ forloop.counter }}_last" placeholder="Last Name"
          value="{{ form_data|get_item:key|default:'' }}">
        {% endwith %}

        {% with key="player_"|add:forloop.counter|stringformat:"s"|add:"_age" %}
        <input name="player_{{ forloop.counter }}_age" type="number" placeholder="Age"
          value="{{ form_data|get_item:key|default:'' }}">
        {% endwith %}

        {% with key="player_"|add:forloop.counter|stringformat:"s"|add:"_gender" %}
        <select name="player_{{ forloop.counter }}_gender">
          <option value="">Gender</option>
          <option value="M" {% if form_data|get_item:key == "M" %}selected{% endif %}>Male</option>
          <option value="F" {% if form_data|get_item:key == "F" %}selected{% endif %}>Female</option>
          <option value="O" {% if form_data|get_item:key == "O" %}selected{% endif %}>Other</option>
          <option value="N" {% if form_data|get_item:key == "N" %}selected{% endif %}>Prefer not to say</option>
        </select>
        {% endwith %}

        {% with key="player_"|add:forloop.counter|stringformat:"s"|add:"_email" %}
        <input name="player_{{ forloop.counter }}_email" type="email" placeholder="Email"
          value="{{ form_data|get_item:key|default:'' }}">
        {% endwith %}

        {% with key="player_"|add:forloop.counter|stringformat:"s"|add:"_phone" %}
        <input name="player_{{ forloop.counter }}_phone" placeholder="Phone"
          value="{{ form_data|get_item:key|default:'' }}">
        {% endwith %}

        {% with key="player_"|add:forloop.counter|stringformat:"s"|add:"_school" %}
        <input name="player_{{ forloop.counter }}_school" placeholder="School (optional)"
          value="{{ form_data|get_item:key|default:'' }}">
        {% endwith %}
      </div>
      {% endfor %}

      <hr>

      <!-- SUBSTITUTES -->
      <h3>Substitutes</h3>

      <div id="sub-1">
        <div class="player-card">
          <div class="player-title">Substitute 1</div>

          <input name="sub_1_first" placeholder="First Name" value="{{ form_data.sub_1_first|default:'' }}">
          <input name="sub_1_last" placeholder="Last Name" value="{{ form_data.sub_1_last|default:'' }}">
          <input name="sub_1_age" type="number" placeholder="Age" value="{{ form_data.sub_1_age|default:'' }}">

          <select name="sub_1_gender">
            <option value="">Gender</option>
            <option value="M" {% if form_data.sub_1_gender == "M" %}selected{% endif %}>Male</option>
            <option value="F" {% if form_data.sub_1_gender == "F" %}selected{% endif %}>Female</option>
            <option value="O" {% if form_data.sub_1_gender == "O" %}selected{% endif %}>Other</option>
            <option value="N" {% if form_data.sub_1_gender == "N" %}selected{% endif %}>Prefer not to say</option>
          </select>

          <input name="sub_1_email" type="email" placeholder="Email" value="{{ form_data.sub_1_email|default:'' }}">
          <input name="sub_1_phone" placeholder="Phone" value="{{ form_data.sub_1_phone|default:'' }}">
          <input name="sub_1_school" placeholder="School (optional)" value="{{ form_data.sub_1_school|default:'' }}">
        </div>
      </div>

      <div id="sub-2">
        <div class="player-card">
          <div class="player-title">Substitute 2</div>

          <input name="sub_2_first" placeholder="First Name" value="{{ form_data.sub_2_first|default:'' }}">
          <input name="sub_2_last" placeholder="Last Name" value="{{ form_data.sub_2_last|default:'' }}">
          <input name="sub_2_age" type="number" placeholder="Age" value="{{ form_data.sub_2_age|default:'' }}">

          <select name="sub_2_gender">
            <option value="">Gender</option>
            <option value="M" {% if form_data.sub_2_gender == "M" %}selected{% endif %}>Male</option>
            <option value="F" {% if form_data.sub_2_gender == "F" %}selected{% endif %}>Female</option>
            <option value="O" {% if form_data.sub_2_gender == "O" %}selected{% endif %}>Other</option>
            <option value="N" {% if form_data.sub_2_gender == "N" %}selected{% endif %}>Prefer not to say</option>
          </select>

          <input name="sub_2_email" type="email" placeholder="Email" value="{{ form_data.sub_2_email|default:'' }}">
          <input name="sub_2_phone" placeholder="Phone" value="{{ form_data.sub_2_phone|default:'' }}">
          <input name="sub_2_school" placeholder="School (optional)" value="{{ form_data.sub_2_school|default:'' }}">
        </div>
      </div>

      <hr>

      <!-- WAIVER -->
      <h3>Participation Waiver</h3>
      <div class="waiver-box">
        <p>
          By registering, you agree to the
          <a href="{% url 'waiver' %}" target="_blank" class="waiver-link">
            Legacy Sports Participation Waiver
          </a>.
        </p>
      </div>

      <label class="waiver-checkbox">
        <input type="checkbox" name="agree_waiver" {% if form_data.agree_waiver %}checked{% endif %} required>
        <span>I confirm that I have read and agree to the waiver.</span>
      </label>

      <button type="submit" id="submitBtn" class="submit-btn">
        Submit Registration
      </button>

    </form>
  </div>
</section>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const rosterSelect = document.getElementById("rosterSize");
    const sub1 = document.getElementById("sub-1");
    const sub2 = document.getElementById("sub-2");

    function updateSubs(value) {
        if (value === "6") {
            sub1.style.display = "none";
            sub2.style.display = "none";
        } else if (value === "7") {
            sub1.style.display = "block";
            sub2.style.display = "none";
        } else if (value === "8") {
            sub1.style.display = "block";
            sub2.style.display = "block";
        }
    }

    updateSubs(rosterSelect.value);

    rosterSelect.addEventListener("change", function () {
        updateSubs(this.value);
    });
});
</script>
{% endblock %}